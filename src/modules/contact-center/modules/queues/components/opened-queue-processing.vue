<template>
  <section>
    <header class="content-header">
      <h3 class="content-title">
        {{ $t('objects.ccenter.queues.processing.processing') }}
      </h3>
    </header>
    <div class="object-input-grid">
      <wt-switcher
        v-if="specificControls['taskProcessing.enabled']"
        :disabled="disableUserInput"
        :label="$t('objects.ccenter.queues.processing.enabled')"
        :model-value="itemInstance.taskProcessing.enabled"
        @update:model-value="setItemProcessingProp({ prop: 'enabled', value: $event })"
      />

      <!--      v-if-->
      <wt-select
        v-if="specificControls['taskProcessing.formSchema']"
        :disabled="disableUserInput || !isProcessingEnabled"
        :label="$t('objects.ccenter.queues.processing.formSchema')"
        :search-method="loadDropdownOptionsSchemaList"
        :value="itemInstance.taskProcessing.formSchema"
        @input="setItemProcessingProp({ prop: 'formSchema', value: $event })"
      />
      <wt-input
        v-if="specificControls['taskProcessing.sec']"
        v-show="isProcessingEnabled"
        :disabled="disableUserInput"
        :label="$t('objects.ccenter.queues.processing.sec')"
        :value="itemInstance.taskProcessing.sec"
        type="number"
        @input="setItemProcessingProp({ prop: 'sec', value: +$event })"
      />
      <wt-input
        v-if="specificControls['taskProcessing.renewalSec']"
        v-show="isProcessingEnabled"
        :disabled="disableUserInput"
        :label="$t('objects.ccenter.queues.processing.renewalSec')"
        :value="itemInstance.taskProcessing.renewalSec"
        type="number"
        @input="setItemProcessingProp({ prop: 'renewalSec', value: +$event })"
      />
      <wt-switcher
        v-if="specificControls['taskProcessing.prolongationOptions.enabled']"
        v-show="isProcessingEnabled"
        :disabled="disableUserInput"
        :label="$t('objects.ccenter.queues.processing.allowProlongation')"
        :model-value="itemInstance.taskProcessing.prolongationOptions.enabled"
        @update:model-value="setItemProlongationOption({ prop: 'enabled', value: $event })"
      />
      <div v-show="isProcessingEnabled" />
      <wt-input
        v-if="specificControls['taskProcessing.prolongationOptions.repeatsNumber']"
        v-show="isProlongationEnabled"
        :disabled="disableUserInput"
        :label="$t('objects.ccenter.queues.processing.repeatsNumber')"
        :value="itemInstance.taskProcessing.prolongationOptions.repeatsNumber"
        min="1"
        type="number"
        @input="setItemProlongationOption({ prop: 'repeatsNumber', value: +$event })"
      />
      <div v-show="isProlongationEnabled" />
      <wt-input
        v-if="specificControls['taskProcessing.prolongationOptions.prolongationTimeSec']"
        v-show="isProlongationEnabled"
        :disabled="disableUserInput"
        :label="$t('objects.ccenter.queues.processing.prolongationTimeSec')"
        :value="itemInstance.taskProcessing.prolongationOptions.prolongationTimeSec"
        min="1"
        type="number"
        @input="setItemProlongationOption({ prop: 'prolongationTimeSec', value: +$event })"
      />
      <div v-show="isProlongationEnabled" />
      <wt-switcher
        v-if="specificControls['taskProcessing.prolongationOptions.isTimeoutRetry']"
        v-show="isProlongationEnabled"
        :disabled="disableUserInput"
        :label="$t('objects.ccenter.queues.processing.isTimeoutRetry')"
        :model-value="itemInstance.taskProcessing.prolongationOptions.isTimeoutRetry"
        @update:model-value="setItemProlongationOption({ prop: 'isTimeoutRetry', value: $event })"
      />
    </div>
  </section>
</template>

<script>
import { mapActions } from 'vuex';
import { EngineRoutingSchemaType } from 'webitel-sdk';

import openedTabComponentMixin from '../../../../../app/mixins/objectPagesMixins/openedObjectTabMixin/openedTabComponentMixin';
import FlowsAPI from '../../../../routing/modules/flow/api/flow';
import QueueTypeProperties from '../lookups/QueueTypeProperties.lookup';

export default {
  name: 'OpenedQueueProcessing',
  mixins: [openedTabComponentMixin],
  computed: {
    specificControls() {
      return QueueTypeProperties[this.itemInstance.type].controls.reduce(
        (controls, control) => ({
          ...controls,
          [control]: true,
        }),
        {},
      );
    },
    isProcessingEnabled() {
      return this.itemInstance.taskProcessing.enabled;
    },
    isProlongationEnabled() {
      return this.itemInstance.taskProcessing.enabled && this.itemInstance.taskProcessing.prolongationOptions.enabled;
    },
  },
  methods: {
    ...mapActions({
      setItemProcessingProp(dispatch, payload) {
        return dispatch(`${this.namespace}/SET_ITEM_PROCESSING_PROPERTY`, payload);
      },
      setItemProlongationOption(dispatch, payload) {
        return dispatch(`${this.namespace}/SET_ITEM_PROLONGATION_OPTION`, payload);
      },
    }),
    loadDropdownOptionsSchemaList(params) {
      return FlowsAPI.getLookup({
        ...params,
        type: [EngineRoutingSchemaType.Processing, EngineRoutingSchemaType.Default],
      });
    },
  },
};
</script>

<style lang="scss" scoped>
</style>
